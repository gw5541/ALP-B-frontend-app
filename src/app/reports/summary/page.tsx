'use client';

import { useState, useEffect, useCallback, Suspense } from 'react';
import { useSearchParams } from 'next/navigation';
import Header from '@/components/common/Header';
import Card from '@/components/common/Card';
import FilterBar from '@/components/common/FilterBar';
import StatTable from '@/components/tables/StatTable';
import HourlyLine from '@/components/charts/HourlyLine';
import MonthlyLine from '@/components/charts/MonthlyLine';
import Pyramid from '@/components/charts/Pyramid';
import ErrorBoundary from '@/components/common/ErrorBoundary';
import { SkeletonChart, SkeletonTable } from '@/components/common/Skeleton';
import { 
  PopulationAggDto,
  AgeDistributionDto,
  HourlyTrendDto,
  WeeklyTrendDto,
  MonthlyTrendDto,
  MonthlyPopulation,
  District,
  NoteDto
} from '@/lib/types';
import { buildAgeDistributionFromBuckets } from '@/lib/charts/pyramid'; // üîß Ï∂îÍ∞Ä
import { apiClient } from '@/lib/apiClient';
import { 
  getToday, 
  getTwentyDaysAgo,  // üîß Ï∂îÍ∞Ä
  getLastMonth, 
  getErrorMessage, 
  parseSearchParams,
  getStoredUserId,  // üîß Ï∂îÍ∞Ä
  convertDbCodeToInternalId // üîß Ï∂îÍ∞Ä
} from '@/lib/utils';
import { DISTRICTS } from '@/components/common/SeoulMap';

type ChartMode = 'hourly' | 'pyramid';
type TimePeriod = 'daily' | 'monthly' | 'yearly';

// Reports Summary Ïª¥Ìè¨ÎÑåÌä∏Î•º Î≥ÑÎèÑÎ°ú Î∂ÑÎ¶¨
const ReportsSummaryContent = () => {
  const searchParams = useSearchParams();
  const [districts, setDistricts] = useState<District[]>([]);
  const [favoriteDistricts, setFavoriteDistricts] = useState<(number | null)[]>([null, null, null]);
  const [monthlyStats, setMonthlyStats] = useState<PopulationAggDto[]>([]);
  const [chartMode, setChartMode] = useState<ChartMode>('hourly');
  const [timePeriod, setTimePeriod] = useState<TimePeriod>('daily');
  const [hourlyData, setHourlyData] = useState<HourlyTrendDto[]>([]);
  const [favoriteHourlyData, setFavoriteHourlyData] = useState<HourlyTrendDto[]>([]);
  const [weeklyData, setWeeklyData] = useState<PopulationAggDto[]>([]);
  const [favoriteWeeklyData, setFavoriteWeeklyData] = useState<PopulationAggDto[][]>([]);
  const [monthlyData, setMonthlyData] = useState<MonthlyPopulation[]>([]);
  const [favoriteMonthlyData, setFavoriteMonthlyData] = useState<MonthlyPopulation[][]>([]);
  const [ageDistribution, setAgeDistribution] = useState<AgeDistributionDto | null>(null);
  const [favoriteAgeDistributions, setFavoriteAgeDistributions] = useState<AgeDistributionDto[]>([]);
  const [loading, setLoading] = useState(false);
  const [chartLoading, setChartLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  // Î©îÎ™® Í¥ÄÎ†® ÏÉÅÌÉúÎì§
  const [memo, setMemo] = useState('');
  const [selectedDistrictId, setSelectedDistrictId] = useState<number | null>(null);
  const [memoLoading, setMemoLoading] = useState(false);
  const [memoSaved, setMemoSaved] = useState(false);
  const [allNotes, setAllNotes] = useState<NoteDto[]>([]);
  const [notesLoading, setNotesLoading] = useState(false);
  const [editingNoteId, setEditingNoteId] = useState<number | null>(null);
  const [editingContent, setEditingContent] = useState('');

  const filters = parseSearchParams(searchParams);

  useEffect(() => {
    loadDistricts();
    loadFavoriteDistricts();
  }, []); // üîß ÏàòÏ†ï: Ìïú Î≤àÎßå Î°úÎìú

  // Í¥ÄÏã¨ ÏßÄÏó≠Ïù¥ Î°úÎìúÎêòÎ©¥ Ï≤´ Î≤àÏß∏ ÏßÄÏó≠ÏùÑ Í∏∞Î≥∏ ÏÑ†ÌÉùÌïòÍ≥† Î©îÎ™® Î°úÎìú
  useEffect(() => {
    const validFavorites = favoriteDistricts.filter((id): id is number => id !== null);
    if (validFavorites.length > 0) {
      setSelectedDistrictId(validFavorites[0]);
      loadAllNotes();
    }
  }, [favoriteDistricts]);

  useEffect(() => {
    loadMonthlyStats();
  }, [
    filters.districtId, 
    filters.from, 
    filters.to, 
    filters.gender, 
    filters.ageBucket,
    favoriteDistricts // üîß Ï∂îÍ∞Ä: favoriteDistricts ÏùòÏ°¥ÏÑ± Ï∂îÍ∞Ä
  ]);

  useEffect(() => {
    loadChartData();
  }, [
    chartMode, 
    timePeriod, 
    filters.districtId,
    filters.date,
    filters.from,
    filters.to,
    filters.gender,
    filters.ageBucket,
    favoriteDistricts
  ]);

  const loadDistricts = async () => {
    try {
      const districtsData = await apiClient.getDistricts();
      setDistricts(districtsData);
    } catch (err) {
      console.error('Failed to load districts:', err);
    }
  };

  const loadFavoriteDistricts = async () => {
    try {
      // üîß ÏàòÏ†ï: Î∞±ÏóîÎìú API ÏÇ¨Ïö©ÏúºÎ°ú Î≥ÄÍ≤Ω
      setError(null);
      
      const userId = getStoredUserId();
      const favorites = await apiClient.getUserFavorites(userId);
      
      console.log('üìç Summary: Î∞±ÏóîÎìúÏóêÏÑú Î∂àÎü¨Ïò® Í¥ÄÏã¨ ÏßÄÏó≠:', favorites);
      
      // üîß ÏàòÏ†ï: Î∞±ÏóîÎìúÏóêÏÑú Ïò® districtIdÎ•º ÎÇ¥Î∂Ä IDÎ°ú Î≥ÄÌôò
      const favoriteIds = favorites.map(fav => {
        return convertDbCodeToInternalId(fav.districtId);
      }).filter((id): id is number => id !== null);
      
      // 3Í∞ú Ïä¨Î°ØÏóê ÎßûÍ≤å Î≥ÄÌôò (Î∂ÄÏ°±Ìïú Î∂ÄÎ∂ÑÏùÄ nullÎ°ú Ï±ÑÏö∞Í∏∞)
      const paddedFavorites: (number | null)[] = [
        favoriteIds[0] || null,
        favoriteIds[1] || null,
        favoriteIds[2] || null
      ];
      
      console.log('üìç Summary: Î≥ÄÌôòÎêú Í¥ÄÏã¨ ÏßÄÏó≠ Î∞∞Ïó¥:', paddedFavorites);
      
      setFavoriteDistricts(paddedFavorites);
    } catch (err) {
      console.error('Failed to load favorite districts from backend:', err);
      
      // üîß fallback: localStorageÏóêÏÑú Î∂àÎü¨Ïò§Í∏∞
    try {
      const saved = localStorage.getItem('favoriteDistricts');
      if (saved) {
        const parsed = JSON.parse(saved);
        setFavoriteDistricts(parsed);
          console.log('üìç Summary: Fallback to localStorage favorites:', parsed);
        }
      } catch (localErr) {
        console.error('Failed to load favorite districts from localStorage:', localErr);
      }
    }
  };

  const loadMonthlyStats = useCallback(async () => {
    try {
      setLoading(true);
      setError(null);

      if (filters.districtId) {
      const params = {
        period: 'MONTHLY' as const,
          districtId: filters.districtId,
        from: filters.from || getLastMonth(),
          to: filters.to || getTwentyDaysAgo(),
        gender: filters.gender,
        ageBucket: filters.ageBucket
      };

        // üîß Ï∂îÍ∞Ä: ÎîîÎ≤ÑÍπÖ Î™®Îìú ÏÑ§Ï†ï
        const DEBUG_MODE = process.env.NODE_ENV === 'development';

        // Î°úÍ∑∏Î•º Îã§ÏùåÍ≥º Í∞ôÏù¥ Ï°∞Í±¥Î∂ÄÎ°ú Î≥ÄÍ≤Ω
        if (DEBUG_MODE) {
          console.log('üìä Summary: Loading monthly stats for specific district:', params);
        }
      const stats = await apiClient.getPopulationStats(params);
      setMonthlyStats(stats);
      } else {
        const selectedDistricts = favoriteDistricts.filter((id): id is number => id !== null);
        
        if (selectedDistricts.length > 0) {
          console.log('üìä Summary: Loading monthly stats for favorite districts (internal IDs):', selectedDistricts);
          
          const statsPromises = selectedDistricts.map(internalDistrictId => 
            apiClient.getPopulationStats({
              period: 'MONTHLY' as const,
              districtId: internalDistrictId,
              from: filters.from || getLastMonth(),
              to: filters.to || getTwentyDaysAgo(),
              gender: filters.gender,
              ageBucket: filters.ageBucket
            })
          );

          const statsResponses = await Promise.all(statsPromises);
          const allStats = statsResponses.flat();
          setMonthlyStats(allStats);
        } else {
          console.log('üìä Summary: No districts selected, clearing monthly stats');
          setMonthlyStats([]);
        }
      }
    } catch (err) {
      setError(getErrorMessage(err));
      console.error('Failed to load monthly stats:', err);
    } finally {
      setLoading(false);
    }
  }, [
    filters.districtId,
    filters.from,
    filters.to,
    filters.gender,
    filters.ageBucket,
    favoriteDistricts
  ]);

  const loadChartData = useCallback(async () => {
    try {
      setChartLoading(true);

      if (chartMode === 'hourly') {
        const districtId = filters.districtId;
        const baseDate = getTwentyDaysAgo();

        // Í∞Å state Ï¥àÍ∏∞Ìôî
        setHourlyData([]);
        setFavoriteHourlyData([]);
        setWeeklyData([]);
        setFavoriteWeeklyData([]);
        setMonthlyData([]);
        setFavoriteMonthlyData([]);

        if (timePeriod === 'daily') {
          // ÏùºÍ∞Ñ: ÏãúÍ∞ÑÎåÄÎ≥Ñ Ï∞®Ìä∏
        const params = {
          districtId,
            date: filters.date || baseDate,
          gender: filters.gender,
          ageBucket: filters.ageBucket
        };

        if (districtId) {
          const hourlyResponse = await apiClient.getHourlyTrends({
            districtId,
            date: params.date,
            gender: params.gender,
            ageBucket: params.ageBucket
          });
          setHourlyData([hourlyResponse]);
        } else {
            // Í¥ÄÏã¨ ÏßÄÏó≠Î≥Ñ ÏãúÍ∞ÑÎåÄÎ≥Ñ Îç∞Ïù¥ÌÑ∞
          const selectedDistricts = favoriteDistricts.filter((id): id is number => id !== null);
          if (selectedDistricts.length > 0) {
            const favoriteHourlyPromises = selectedDistricts.map(internalDistrictId =>
              apiClient.getHourlyTrends({
                districtId: internalDistrictId,
                date: params.date,
                gender: params.gender,
                ageBucket: params.ageBucket
              })
            );
            const favoriteHourlyResponses = await Promise.all(favoriteHourlyPromises);
            setFavoriteHourlyData(favoriteHourlyResponses);
            }
          }
        } else if (timePeriod === 'monthly') {
          // Ï£ºÍ∞Ñ: ÏöîÏùºÎ≥Ñ Ï∞®Ìä∏
          const weekRange = getWeekRange(baseDate);
          const params = {
            districtId,
            period: 'DAILY' as const,
            from: weekRange.start,
            to: weekRange.end,
            gender: filters.gender,
            ageBucket: filters.ageBucket
          };

          if (districtId) {
            const weeklyResponse = await apiClient.getPopulationStats(params);
            setWeeklyData(weeklyResponse);
          } else {
            // Í¥ÄÏã¨ ÏßÄÏó≠Î≥Ñ ÏöîÏùºÎ≥Ñ Îç∞Ïù¥ÌÑ∞
            const selectedDistricts = favoriteDistricts.filter((id): id is number => id !== null);
            if (selectedDistricts.length > 0) {
              const favoriteWeeklyPromises = selectedDistricts.map(internalDistrictId =>
                apiClient.getPopulationStats({
                  ...params,
                  districtId: internalDistrictId
                })
              );
              const favoriteWeeklyResponses = await Promise.all(favoriteWeeklyPromises);
              setFavoriteWeeklyData(favoriteWeeklyResponses);
            }
          }
        } else if (timePeriod === 'yearly') {
          // Ïó∞Í∞Ñ: Ï£ºÏ∞®Î≥Ñ Ï∞®Ìä∏
          if (districtId) {
            const monthlyResponse = await apiClient.getWeeklyTrends({
              districtId,
              weeks: 5,
              gender: filters.gender,
              ageBucket: filters.ageBucket
            });
            const convertedData = convertWeeklyToMonthlyPopulation(monthlyResponse);
            setMonthlyData(convertedData);
          } else {
            // Í¥ÄÏã¨ ÏßÄÏó≠Î≥Ñ Ï£ºÏ∞®Î≥Ñ Îç∞Ïù¥ÌÑ∞
            const selectedDistricts = favoriteDistricts.filter((id): id is number => id !== null);
            if (selectedDistricts.length > 0) {
              const favoriteMonthlyPromises = selectedDistricts.map(async (internalDistrictId) => {
                const monthlyResponse = await apiClient.getWeeklyTrends({
                  districtId: internalDistrictId,
                  weeks: 5,
                  gender: filters.gender,
                  ageBucket: filters.ageBucket
                });
                return convertWeeklyToMonthlyPopulation(monthlyResponse);
              });
              const favoriteMonthlyResponses = await Promise.all(favoriteMonthlyPromises);
              setFavoriteMonthlyData(favoriteMonthlyResponses);
            }
          }
        }
      } else if (chartMode === 'pyramid') {
        const baseDate = getTwentyDaysAgo();
        const districtId = filters.districtId;

        if (districtId) {
          // ÌäπÏ†ï ÏßÄÏó≠ ÏÑ†ÌÉù Ïãú
          const params = {
            districtId,
            period: 'DAILY' as const,
            from: filters.from || baseDate,
            to: filters.to || baseDate,
            gender: filters.gender,
            ageBucket: filters.ageBucket
          };

          console.log('üìä Summary: Loading age distribution for specific district:', params);

          try {
            const statsResponse = await apiClient.getPopulationStats(params);
            
            if (statsResponse && statsResponse.length > 0) {
              const ageStats = statsResponse[0];
              
              if (ageStats.maleBucketsAvg && ageStats.femaleBucketsAvg) {
                const ageDistributionArray = buildAgeDistributionFromBuckets(
                  ageStats.maleBucketsAvg,
                  ageStats.femaleBucketsAvg
                );

                if (ageDistributionArray.length > 0) {
                  const ageDistributionDto: AgeDistributionDto = {
                    districtId: ageStats.districtId,
                    districtName: ageStats.districtName,
                    from: params.from,
                    to: params.to,
                    ageDistribution: ageDistributionArray
                  };

                  setAgeDistribution(ageDistributionDto);
                  setFavoriteAgeDistributions([]); // ÌäπÏ†ï ÏßÄÏó≠ ÏÑ†ÌÉù Ïãú Í¥ÄÏã¨ ÏßÄÏó≠ Îç∞Ïù¥ÌÑ∞ Ï¥àÍ∏∞Ìôî
                } else {
                  setAgeDistribution(null);
                  setFavoriteAgeDistributions([]);
                }
              } else {
                setAgeDistribution(null);
                setFavoriteAgeDistributions([]);
              }
            } else {
              setAgeDistribution(null);
              setFavoriteAgeDistributions([]);
            }
          } catch (ageError) {
            console.error('‚ùå Summary: Age distribution loading failed:', ageError);
            setAgeDistribution(null);
            setFavoriteAgeDistributions([]);
          }
        } else {
          // Í¥ÄÏã¨ ÏßÄÏó≠Î≥ÑÎ°ú Í∞úÎ≥Ñ Ïó∞Î†πÎåÄ Î∂ÑÌè¨ Îç∞Ïù¥ÌÑ∞ Î°úÎìú
          const selectedDistricts = favoriteDistricts.filter((id): id is number => id !== null);
          
          if (selectedDistricts.length > 0) {
            console.log('üìä Summary: Loading age distributions for favorite districts:', selectedDistricts);
            
            const favoriteAgePromises = selectedDistricts.map(async (internalDistrictId) => {
              const params = {
                districtId: internalDistrictId,
                period: 'DAILY' as const,
                from: filters.from || baseDate,
                to: filters.to || baseDate,
                gender: filters.gender,
                ageBucket: filters.ageBucket
              };

              try {
                const statsResponse = await apiClient.getPopulationStats(params);
                
                if (statsResponse && statsResponse.length > 0) {
                  const ageStats = statsResponse[0];
                  
                  if (ageStats.maleBucketsAvg && ageStats.femaleBucketsAvg) {
                    const ageDistributionArray = buildAgeDistributionFromBuckets(
                      ageStats.maleBucketsAvg,
                      ageStats.femaleBucketsAvg
                    );

                    if (ageDistributionArray.length > 0) {
                      return {
                        districtId: ageStats.districtId,
                        districtName: ageStats.districtName,
                        from: params.from,
                        to: params.to,
                        ageDistribution: ageDistributionArray
                      } as AgeDistributionDto;
                    }
                  }
                }
                return null;
              } catch (error) {
                console.error(`Failed to load age distribution for district ${internalDistrictId}:`, error);
                return null;
              }
            });
            
            const favoriteAgeResponses = await Promise.all(favoriteAgePromises);
            const validAgeDistributions = favoriteAgeResponses.filter((dist): dist is AgeDistributionDto => dist !== null);
            

            
            setFavoriteAgeDistributions(validAgeDistributions);
            setAgeDistribution(null); // Í¥ÄÏã¨ ÏßÄÏó≠ Î™®ÎìúÏóêÏÑúÎäî Í∏∞Ï°¥ Îã®Ïùº Îç∞Ïù¥ÌÑ∞ Ï¥àÍ∏∞Ìôî
          } else {
            setFavoriteAgeDistributions([]);
            setAgeDistribution(null);
          }
        }
      }
    } catch (err) {
      console.error('Failed to load chart data:', err);
    } finally {
      setChartLoading(false);
    }
  }, [
    chartMode,
    timePeriod,
    filters.districtId,
    filters.date,
    filters.from,
    filters.to,
    filters.gender,
    filters.ageBucket,
    monthlyStats, // üîß Ï∂îÍ∞Ä: monthlyStats ÏùòÏ°¥ÏÑ± (hourly Ï∞®Ìä∏ÏóêÏÑú ÏÇ¨Ïö©)
    favoriteDistricts // üîß Ï∂îÍ∞Ä: favoriteDistricts ÏùòÏ°¥ÏÑ±
  ]);

  // üîß Ï∂îÍ∞Ä: Í∞ôÏùÄ Íµ¨Ïùò Ï§ëÎ≥µ Îç∞Ïù¥ÌÑ∞ Ï†úÍ±∞ (ÏµúÏã† Îç∞Ïù¥ÌÑ∞Îßå Ïú†ÏßÄ)
  const getUniqueDistrictStats = useCallback((stats: PopulationAggDto[]): PopulationAggDto[] => {
    if (!stats || stats.length === 0) return [];

    // districtIdÎ≥ÑÎ°ú Í∑∏Î£πÌôî
    const groupedByDistrict = stats.reduce((acc, stat) => {
      const districtId = stat.districtId;
      if (!acc[districtId]) {
        acc[districtId] = [];
      }
      acc[districtId].push(stat);
      return acc;
    }, {} as Record<number, PopulationAggDto[]>);

    // Í∞Å Í∑∏Î£πÏóêÏÑú Í∞ÄÏû• ÏµúÏã† Îç∞Ïù¥ÌÑ∞Îßå ÏÑ†ÌÉù
    const uniqueStats = Object.values(groupedByDistrict).map(districtStats => {
      // periodStartDate Í∏∞Ï§ÄÏúºÎ°ú Ï†ïÎ†¨ (ÏµúÏã†Ïàú)
      const sortedStats = districtStats.sort((a, b) => 
        new Date(b.periodStartDate).getTime() - new Date(a.periodStartDate).getTime()
      );
      
      console.log(`üìä District ${districtStats[0].districtName}: ${districtStats.length} records, latest: ${sortedStats[0].periodStartDate}`);
      
      return sortedStats[0]; // Í∞ÄÏû• ÏµúÏã† Îç∞Ïù¥ÌÑ∞ Î∞òÌôò
    });

    console.log('üìä Summary: Original stats count:', stats.length);
    console.log('üìä Summary: Unique stats count:', uniqueStats.length);
    
    return uniqueStats;
  }, []);

  // üîß Ï∂îÍ∞Ä: ÌÖåÏù¥Î∏î subtitle ÎèôÏ†Å ÏÉùÏÑ±
  const getTableSubtitle = useCallback(() => {
    const uniqueStats = getUniqueDistrictStats(monthlyStats);
    if (uniqueStats.length === 0) return "ÏûêÏπòÍµ¨Î≥Ñ ÏõîÍ∞Ñ ÏÉùÌôúÏù∏Íµ¨ ÌÜµÍ≥Ñ";
    
    // Í∞ÄÏû• ÎßéÏù¥ ÏÇ¨Ïö©Îêú Í∏∞Í∞Ñ Ï∞æÍ∏∞
    const periods = uniqueStats.map(stat => stat.periodStartDate);
    const mostCommonPeriod = periods.reduce((acc, period) => {
      acc[period] = (acc[period] || 0) + 1;
      return acc;
    }, {} as Record<string, number>);
    
    const latestPeriod = Object.keys(mostCommonPeriod).sort().reverse()[0];
    
    if (latestPeriod) {
      const formattedDate = new Date(latestPeriod).toLocaleDateString('ko-KR', {
        year: 'numeric',
        month: 'long'
      });
      return `ÏûêÏπòÍµ¨Î≥Ñ ÏõîÍ∞Ñ ÏÉùÌôúÏù∏Íµ¨ ÌÜµÍ≥Ñ (${formattedDate} Í∏∞Ï§Ä)`;
    }
    
    return "ÏûêÏπòÍµ¨Î≥Ñ ÏõîÍ∞Ñ ÏÉùÌôúÏù∏Íµ¨ ÌÜµÍ≥Ñ";
  }, [monthlyStats, getUniqueDistrictStats]);

  // Districts ÌéòÏù¥ÏßÄÏóêÏÑú Í∞ÄÏ†∏Ïò® Ìó¨Ìçº Ìï®ÏàòÎì§
  const getWeekRange = (date: string) => {
    const targetDate = new Date(date);
    const dayOfWeek = targetDate.getDay();
    
    const mondayOfWeek = new Date(targetDate);
    const daysToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
    mondayOfWeek.setDate(targetDate.getDate() + daysToMonday);
    
    const sundayOfWeek = new Date(mondayOfWeek);
    sundayOfWeek.setDate(mondayOfWeek.getDate() + 6);
    
    return {
      start: mondayOfWeek.toISOString().split('T')[0],
      end: sundayOfWeek.toISOString().split('T')[0]
    };
  };

  const convertToWeeklyChartData = (dailyStats: PopulationAggDto[]) => {
    if (!dailyStats || dailyStats.length === 0) return [];
    
    const dayOfWeekMap: Record<number, { total: number; count: number; name: string }> = {
      0: { total: 0, count: 0, name: 'ÏùºÏöîÏùº' },
      1: { total: 0, count: 0, name: 'ÏõîÏöîÏùº' },
      2: { total: 0, count: 0, name: 'ÌôîÏöîÏùº' },
      3: { total: 0, count: 0, name: 'ÏàòÏöîÏùº' },
      4: { total: 0, count: 0, name: 'Î™©ÏöîÏùº' },
      5: { total: 0, count: 0, name: 'Í∏àÏöîÏùº' },
      6: { total: 0, count: 0, name: 'ÌÜ†ÏöîÏùº' }
    };
    
    dailyStats.forEach(stat => {
      const date = new Date(stat.periodStartDate);
      const dayOfWeek = date.getDay();
      
      if (dayOfWeekMap[dayOfWeek]) {
        dayOfWeekMap[dayOfWeek].total += stat.totalAvg;
        dayOfWeekMap[dayOfWeek].count += 1;
      }
    });
    
    const orderedDays = [1, 2, 3, 4, 5, 6, 0];
    
    return orderedDays.map((dayIndex, chartIndex) => {
      const dayData = dayOfWeekMap[dayIndex];
      const avgValue = dayData.count > 0 ? Math.round(dayData.total / dayData.count) : 0;
      
      return {
        hour: chartIndex,
        value: avgValue,
        hourLabel: dayData.name,
        date: dayData.name,
        dayOfWeek: dayIndex,
        dataCount: dayData.count
      };
    });
  };

  const convertWeeklyToMonthlyPopulation = (weeklyResponse: WeeklyTrendDto): MonthlyPopulation[] => {
    if (!weeklyResponse?.weeklyData || weeklyResponse.weeklyData.length === 0) {
      return [];
    }
    
    const sortedWeeklyData = weeklyResponse.weeklyData
      .map(item => {
        const weekMatch = item.weekPeriod.match(/W(\d+)/);
        const weekNumber = weekMatch ? parseInt(weekMatch[1]) : 0;
        return { ...item, weekNumber };
      })
      .sort((a, b) => a.weekNumber - b.weekNumber);
    
    return sortedWeeklyData.map((item, index) => ({
      month: `${index + 1}Ï£ºÏ∞®`,
      value: item.totalAvg,
      districtId: weeklyResponse.districtId
    }));
  };

  // Î©îÎ™® Í¥ÄÎ†® Ìï®ÏàòÎì§
  const districtCodeMap: Record<number, number> = {
    1: 11680,   // Í∞ïÎÇ®Íµ¨
    2: 11740,   // Í∞ïÎèôÍµ¨  
    3: 11305,   // Í∞ïÎ∂ÅÍµ¨
    4: 11500,   // Í∞ïÏÑúÍµ¨
    5: 11620,   // Í¥ÄÏïÖÍµ¨
    6: 11215,   // Í¥ëÏßÑÍµ¨
    7: 11530,   // Íµ¨Î°úÍµ¨
    8: 11545,   // Í∏àÏ≤úÍµ¨
    9: 11350,   // ÎÖ∏ÏõêÍµ¨
    10: 11320,  // ÎèÑÎ¥âÍµ¨
    11: 11230,  // ÎèôÎåÄÎ¨∏Íµ¨
    12: 11590,  // ÎèôÏûëÍµ¨
    13: 11440,  // ÎßàÌè¨Íµ¨
    14: 11410,  // ÏÑúÎåÄÎ¨∏Íµ¨
    15: 11650,  // ÏÑúÏ¥àÍµ¨
    16: 11200,  // ÏÑ±ÎèôÍµ¨
    17: 11290,  // ÏÑ±Î∂ÅÍµ¨
    18: 11710,  // ÏÜ°ÌååÍµ¨
    19: 11470,  // ÏñëÏ≤úÍµ¨
    20: 11560,  // ÏòÅÎì±Ìè¨Íµ¨
    21: 11170,  // Ïö©ÏÇ∞Íµ¨
    22: 11380,  // ÏùÄÌèâÍµ¨
    23: 11110,  // Ï¢ÖÎ°úÍµ¨
    24: 11140,  // Ï§ëÍµ¨
    25: 11260   // Ï§ëÎûëÍµ¨
  };

  const saveMemo = async () => {
    if (!selectedDistrictId || !memo.trim()) return;

    try {
      setMemoLoading(true);
      const userId = getStoredUserId();
      const dbDistrictId = districtCodeMap[selectedDistrictId];
      
      console.log('üìù Summary saveMemo:', {
        selectedDistrictId,
        dbDistrictId,
        districtCodeMap: districtCodeMap[selectedDistrictId]
      });
      
      if (!dbDistrictId) {
        console.error('‚ùå Summary: Invalid districtId mapping', { selectedDistrictId, districtCodeMap });
        throw new Error(`ÏûêÏπòÍµ¨ ÏΩîÎìúÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§: ${selectedDistrictId}`);
      }
      
      // createNoteÏóê ÎÇ¥Î∂Ä IDÎ•º Ï†ÑÎã¨ (createNote Ìï®ÏàòÏóêÏÑú DB ÏΩîÎìúÎ°ú Î≥ÄÌôò)
      await apiClient.createNote(userId, {
        districtId: selectedDistrictId, // ÎÇ¥Î∂Ä ID Ï†ÑÎã¨
        content: memo.trim()
      });
      
      setMemo('');
      setMemoSaved(true);
      loadAllNotes();
      
      setTimeout(() => {
        setMemoSaved(false);
      }, 3000);
    } catch (err) {
      console.error('Failed to save memo:', err);
    } finally {
      setMemoLoading(false);
    }
  };

  const loadAllNotes = async () => {
    try {
      setNotesLoading(true);
      const userId = getStoredUserId();
      
      // Î™®Îì† Í¥ÄÏã¨ ÏßÄÏó≠Ïùò Î©îÎ™®Îì§ÏùÑ Î°úÎìú
      const validFavorites = favoriteDistricts.filter((id): id is number => id !== null);
      if (validFavorites.length === 0) {
        setAllNotes([]);
        return;
      }

      const notePromises = validFavorites.map(async (internalId) => {
        console.log(`üìù Summary loadAllNotes: Loading notes for internal ID ${internalId}`);
        const notes = await apiClient.getUserNotes(userId, internalId); // ÎÇ¥Î∂Ä ID ÏßÅÏ†ë Ï†ÑÎã¨
        return notes.map(note => ({
          ...note,
          internalDistrictId: internalId // ÎÇ¥Î∂Ä IDÎèÑ Ìï®Íªò Ï†ÄÏû•
        }));
      });

      const allNotesArrays = await Promise.all(notePromises);
      const allNotesFlat = allNotesArrays.flat();
      
      // ÏµúÏã†ÏàúÏúºÎ°ú Ï†ïÎ†¨
      const sortedNotes = allNotesFlat.sort((a, b) => 
        new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime()
      );
      
      setAllNotes(sortedNotes);
    } catch (err) {
      console.error('Failed to load all notes:', err);
    } finally {
      setNotesLoading(false);
    }
  };

  const startEditingNote = (note: NoteDto) => {
    setEditingNoteId(note.noteId);
    setEditingContent(note.content);
  };

  const cancelEditingNote = () => {
    setEditingNoteId(null);
    setEditingContent('');
  };

  const saveEditingNote = async () => {
    if (!editingNoteId || !editingContent.trim()) return;

    try {
      setNotesLoading(true);
      const userId = getStoredUserId();
      
      await apiClient.updateNote(userId, editingNoteId, {
        content: editingContent.trim()
      });

      setAllNotes(prev => prev.map(note => 
        note.noteId === editingNoteId 
          ? { ...note, content: editingContent.trim() } 
          : note
      ));
      
      setEditingNoteId(null);
      setEditingContent('');
    } catch (err) {
      console.error('Failed to update note:', err);
    } finally {
      setNotesLoading(false);
    }
  };

  const deleteNoteFromList = async (noteId: number) => {
    try {
      setNotesLoading(true);
      const userId = getStoredUserId();
      
      await apiClient.deleteNote(userId, noteId);
      setAllNotes(prev => prev.filter(note => note.noteId !== noteId));
    } catch (err) {
      console.error('Failed to delete note:', err);
    } finally {
      setNotesLoading(false);
    }
  };

  const renderChart = () => {
    if (chartLoading) {
      return <SkeletonChart />;
    }

    if (chartMode === 'hourly') {
      if (timePeriod === 'daily') {
        // ÏùºÍ∞Ñ: ÏãúÍ∞ÑÎåÄÎ≥Ñ Ï∞®Ìä∏
      if (hourlyData.length > 0) {
          return (
            <HourlyLine 
              series={hourlyData[0].currentData}
              title={`${hourlyData[0].districtName || 'ÏûêÏπòÍµ¨'} ÏãúÍ∞ÑÎåÄÎ≥Ñ Ïù∏Íµ¨`}
              height={350}
            />
          );
        }

      if (favoriteHourlyData.length > 0) {
        return (
          <div className="space-y-6">
            <h4 className="text-lg font-medium text-gray-900 mb-4">Í¥ÄÏã¨ ÏßÄÏó≠Î≥Ñ ÏãúÍ∞ÑÎåÄÎ≥Ñ Ïù∏Íµ¨ ÌòÑÌô©</h4>
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
              {favoriteHourlyData.map((data, index) => (
                <div key={data.districtId || index} className="bg-white border border-gray-200 rounded-lg p-4">
                  <HourlyLine 
                    series={data.currentData}
                    title={`${data.districtName || `ÏûêÏπòÍµ¨ ${data.districtId}`}`}
                    height={280}
                  />
                </div>
              ))}
            </div>
          </div>
        );
        }
      } else if (timePeriod === 'monthly') {
        // Ï£ºÍ∞Ñ: ÏöîÏùºÎ≥Ñ Ï∞®Ìä∏
        if (weeklyData.length > 0) {
          const weeklyChartData = convertToWeeklyChartData(weeklyData);
          return (
            <HourlyLine 
              series={weeklyChartData}
              title="Ï£ºÍ∞Ñ Ïù∏Íµ¨ ÌòÑÌô© (ÏöîÏùºÎ≥Ñ ÌèâÍ∑†)"
              height={350}
              chartType="weekly"
            />
          );
        }

        if (favoriteWeeklyData.length > 0) {
          return (
            <div className="space-y-6">
              <h4 className="text-lg font-medium text-gray-900 mb-4">Í¥ÄÏã¨ ÏßÄÏó≠Î≥Ñ ÏöîÏùºÎ≥Ñ Ïù∏Íµ¨ ÌòÑÌô©</h4>
              <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                {favoriteWeeklyData.map((data, index) => {
                  const weeklyChartData = convertToWeeklyChartData(data);
                  const districtName = data[0]?.districtName || `ÏûêÏπòÍµ¨ ${data[0]?.districtId}`;
                  return (
                    <div key={index} className="bg-white border border-gray-200 rounded-lg p-4">
                      <HourlyLine 
                        series={weeklyChartData}
                        title={districtName}
                        height={280}
                        chartType="weekly"
                      />
                    </div>
                  );
                })}
              </div>
            </div>
          );
        }
      } else if (timePeriod === 'yearly') {
        // Ïó∞Í∞Ñ: Ï£ºÏ∞®Î≥Ñ Ï∞®Ìä∏
        if (monthlyData.length > 0) {
          return (
            <MonthlyLine 
              data={monthlyData}
              title="Ï£ºÏ∞®Î≥Ñ Ïù∏Íµ¨ ÌòÑÌô©"
              height={350}
              color="#ef4444"
            />
          );
        }

        if (favoriteMonthlyData.length > 0) {
          return (
            <div className="space-y-6">
              <h4 className="text-lg font-medium text-gray-900 mb-4">Í¥ÄÏã¨ ÏßÄÏó≠Î≥Ñ Ï£ºÏ∞®Î≥Ñ Ïù∏Íµ¨ ÌòÑÌô©</h4>
              <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                {favoriteMonthlyData.map((data, index) => {
                  // Í¥ÄÏã¨ ÏßÄÏó≠ Î∞∞Ïó¥ÏóêÏÑú Ìï¥Îãπ Ïù∏Îç±Ïä§Ïùò ÎÇ¥Î∂Ä ID Í∞ÄÏ†∏Ïò§Í∏∞
                  const validFavorites = favoriteDistricts.filter((id): id is number => id !== null);
                  const internalId = validFavorites[index];
                  const district = DISTRICTS.find(d => d.id === internalId);
                  const districtName = district?.name || `ÏßÄÏó≠ ${index + 1}`;
                  
                  return (
                    <div key={index} className="bg-white border border-gray-200 rounded-lg p-4">
                      <MonthlyLine 
                        data={data}
                        title={districtName}
                        height={280}
                        color="#ef4444"
                      />
                    </div>
                  );
                })}
              </div>
            </div>
          );
        }
      }

      return (
        <div className="h-64 flex items-center justify-center text-gray-500">
          {timePeriod === 'daily' && 'ÏãúÍ∞ÑÎåÄÎ≥Ñ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§'}
          {timePeriod === 'monthly' && 'ÏöîÏùºÎ≥Ñ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§'}
          {timePeriod === 'yearly' && 'Ï£ºÏ∞®Î≥Ñ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§'}
        </div>
      );
    }

    if (chartMode === 'pyramid') {
      // ÌäπÏ†ï ÏßÄÏó≠Ïù¥ ÏÑ†ÌÉùÎêú Í≤ΩÏö∞ (Í∏∞Ï°¥ Î°úÏßÅ)
      if (ageDistribution?.ageDistribution?.length) {
        return (
          <Pyramid 
            data={ageDistribution.ageDistribution}
            title="Ïó∞Î†πÎåÄÎ≥Ñ Ïù∏Íµ¨ Î∂ÑÌè¨"
            height={350}
          />
        );
      }

      // Í¥ÄÏã¨ ÏßÄÏó≠Î≥Ñ Í∞úÎ≥Ñ Ï∞®Ìä∏Îì§
      if (favoriteAgeDistributions.length > 0) {
        const periodLabel = 'ÏùºÍ∞Ñ ÌèâÍ∑†'; // Ïó∞Î†πÎåÄÎ≥Ñ Î∂ÑÌè¨Îäî Ìï≠ÏÉÅ ÏùºÍ∞Ñ Îç∞Ïù¥ÌÑ∞ ÏÇ¨Ïö©
        return (
          <div className="space-y-6">
            <h4 className="text-lg font-medium text-gray-900 mb-4">{periodLabel} Ïó∞Î†πÎåÄÎ≥Ñ Ïù∏Íµ¨ Î∂ÑÌè¨</h4>
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
              {favoriteAgeDistributions.map((data, index) => (
                <div key={data.districtId || index} className="bg-white border border-gray-200 rounded-lg p-6">
                  <Pyramid 
                    data={data.ageDistribution}
                    title={`${data.districtName || `ÏûêÏπòÍµ¨ ${data.districtId}`}`}
                    height={320}
                  />
                </div>
              ))}
            </div>
          </div>
        );
      }

      return (
        <div className="h-64 flex items-center justify-center text-gray-500">
          Ïó∞Î†πÎåÄÎ≥Ñ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§
        </div>
      );
    }

    return null;
  };

  return (
    <>
        <Header />
        
        <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
          {/* Header Section */}
          <div className="mb-8">
            <h1 className="text-3xl font-bold text-gray-900 mb-2">ÏöîÏïΩ Î≥¥Í≥†ÏÑú</h1>
            <p className="text-gray-600">Í¥ÄÏã¨ ÏûêÏπòÍµ¨Ïùò ÏÉùÌôúÏù∏Íµ¨ ÌòÑÌô©ÏùÑ ÌïúÎààÏóê ÌôïÏù∏ÌïòÏÑ∏Ïöî</p>
            
            {/* ÌòÑÏû¨ Í¥ÄÏã¨ ÏßÄÏó≠ ÌëúÏãú */}
            <div className="mt-4 p-4 bg-blue-50 rounded-lg border border-blue-200">
              <h3 className="text-sm font-semibold text-blue-900 mb-2">ÌòÑÏû¨ Í¥ÄÏã¨ ÏßÄÏó≠</h3>
              <div className="flex flex-wrap gap-2">
                {favoriteDistricts.filter(id => id !== null).length > 0 ? (
                  favoriteDistricts
                    .filter((id): id is number => id !== null)
                    .map((districtId) => {
                      const district = DISTRICTS.find(d => d.id === districtId);
                      return (
                        <span
                          key={districtId}
                          className="inline-flex items-center px-3 py-1 rounded-full text-sm bg-blue-100 text-blue-800 border border-blue-300"
                        >
                          {district?.name || `ÏûêÏπòÍµ¨ ${districtId}`}
                        </span>
                      );
                    })
                ) : (
                  <span className="text-sm text-blue-600">
                    Í¥ÄÏã¨ ÏßÄÏó≠Ïù¥ ÏÑ§Ï†ïÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§. 
                    <a href="/dashboard" className="underline hover:text-blue-700 ml-1">
                      ÎåÄÏãúÎ≥¥ÎìúÏóêÏÑú ÏÑ§Ï†ïÌïòÍ∏∞
                    </a>
                  </span>
                )}
              </div>
            </div>
          </div>

          {/* Filters (ÏûÑÏãú ÎπÑÌôúÏÑ±Ìôî) */}
          <div className="mb-6 relative">
            <FilterBar
              showDistrictFilter={true}
              showGenderFilter={true}
              showAgeBucketFilter={true}
              showDateFilter={chartMode === 'hourly'}
            showPresetManager={true}
              districts={districts}
            />
            {/* ÌïÑÌÑ∞ ÎπÑÌôúÏÑ±Ìôî Ïò§Î≤ÑÎ†àÏù¥ */}
            <div className="absolute inset-0 bg-gray-500 bg-opacity-30 rounded-lg flex items-center justify-center pointer-events-auto cursor-not-allowed">
              <div className="bg-white px-4 py-2 rounded-md shadow-md">
                <p className="text-sm text-gray-600 font-medium">ÌïÑÌÑ∞ Í∏∞Îä• Í∞úÎ∞ú Ï§ë...</p>
          </div>
              </div>
          </div>

          {/* Chart Section */}
          <div className="mb-8">
            <Card>
              {/* Chart Mode Toggle */}
              <div className="flex items-center justify-between mb-6">
                <h3 className="text-lg font-semibold text-gray-900">ÏÉÅÏÑ∏ Î∂ÑÏÑù</h3>
                <div className="flex bg-gray-100 rounded-lg p-1">
                  <button
                    onClick={() => setChartMode('hourly')}
                    className={`px-4 py-2 rounded-md text-sm font-medium transition-colors ${
                      chartMode === 'hourly'
                        ? 'bg-white text-gray-900 shadow-sm'
                        : 'text-gray-600 hover:text-gray-900'
                    }`}
                  >
                    ÏãúÍ∞ÑÎåÄÎ≥Ñ ÌòÑÌô©
                  </button>
                  <button
                    onClick={() => setChartMode('pyramid')}
                    className={`px-4 py-2 rounded-md text-sm font-medium transition-colors ${
                      chartMode === 'pyramid'
                        ? 'bg-white text-gray-900 shadow-sm'
                        : 'text-gray-600 hover:text-gray-900'
                    }`}
                  >
                    Ïó∞Î†πÎåÄÎ≥Ñ Î∂ÑÌè¨
                  </button>
                </div>
              </div>

              {/* Chart Content */}
              {renderChart()}

              {/* Time Period Toggle - ÌïòÎã®ÏúºÎ°ú Ïù¥Îèô */}
              {chartMode === 'hourly' && (
                <div className="flex items-center justify-center mt-6 pt-4 border-t border-gray-200">
                  <div className="flex bg-red-50 rounded-lg p-1">
                    <button
                      onClick={() => setTimePeriod('daily')}
                      className={`px-4 py-2 rounded-md text-sm font-medium transition-colors ${
                        timePeriod === 'daily'
                          ? 'bg-red-600 text-white shadow-sm'
                          : 'text-red-600 hover:text-red-700'
                      }`}
                    >
                      ÏùºÍ∞Ñ
                    </button>
                    <button
                      onClick={() => setTimePeriod('monthly')}
                      className={`px-4 py-2 rounded-md text-sm font-medium transition-colors ${
                        timePeriod === 'monthly'
                          ? 'bg-red-600 text-white shadow-sm'
                          : 'text-red-600 hover:text-red-700'
                      }`}
                    >
                      Ï£ºÍ∞Ñ
                    </button>
                    <button
                      onClick={() => setTimePeriod('yearly')}
                      className={`px-4 py-2 rounded-md text-sm font-medium transition-colors ${
                        timePeriod === 'yearly'
                          ? 'bg-red-600 text-white shadow-sm'
                          : 'text-red-600 hover:text-red-700'
                      }`}
                    >
                      Ïó∞Í∞Ñ
                    </button>
                  </div>
                </div>
              )}
            </Card>
          </div>

          {/* Summary Table */}
          <div className="mb-8">
          <Card title="ÏõîÍ∞Ñ ÏßëÍ≥Ñ ÌòÑÌô©" subtitle={getTableSubtitle()}>
            {loading ? (
              <SkeletonTable rows={10} cols={5} />
            ) : error ? (
              <div className="text-center py-8 text-red-600">
                {error}
              </div>
            ) : (
              <StatTable data={getUniqueDistrictStats(monthlyStats)} />
            )}
            </Card>
          </div>

          {/* Memo Section */}
          <div className="mb-8">
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
              {/* Î©îÎ™® ÏûëÏÑ± Ïπ¥Îìú */}
              <Card title="Î∂ÑÏÑù Î©îÎ™® ÏûëÏÑ±">
                <div className="space-y-4">
                  {/* ÏûêÏπòÍµ¨ ÏÑ†ÌÉù ÎìúÎ°≠Îã§Ïö¥ */}
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      ÏûêÏπòÍµ¨ ÏÑ†ÌÉù
                    </label>
                    <select
                      value={selectedDistrictId || ''}
                      onChange={(e) => setSelectedDistrictId(Number(e.target.value) || null)}
                      className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    >
                      <option value="">ÏûêÏπòÍµ¨Î•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</option>
                      {favoriteDistricts
                        .filter((id): id is number => id !== null)
                        .map((districtId) => {
                          const district = DISTRICTS.find(d => d.id === districtId);
                          return (
                            <option key={districtId} value={districtId}>
                              {district?.name || `ÏûêÏπòÍµ¨ ${districtId}`}
                            </option>
                          );
                        })}
                    </select>
                  </div>

                  {/* Î©îÎ™® ÏûÖÎ†• */}
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Î©îÎ™® ÎÇ¥Ïö©
                    </label>
                    <textarea
                      value={memo}
                      onChange={(e) => setMemo(e.target.value)}
                      placeholder="Î∂ÑÏÑù ÎÇ¥Ïö©Ïù¥ÎÇò Ï§ëÏöîÌïú Ïù∏ÏÇ¨Ïù¥Ìä∏Î•º Í∏∞Î°ùÌïòÏÑ∏Ïöî..."
                      className="w-full h-32 px-3 py-2 border border-gray-300 rounded-md resize-none focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    />
                  </div>

                  {/* Ï†ÄÏû• Î≤ÑÌäº */}
                  <div className="flex items-center justify-between">
                    <div className="flex items-center space-x-2">
                      {memoSaved && (
                        <span className="text-sm text-green-600 flex items-center">
                          <svg className="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                            <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" />
                          </svg>
                          Ï†ÄÏû•Îê®
                        </span>
                      )}
                    </div>
                    <button
                      onClick={saveMemo}
                      disabled={memoLoading || !selectedDistrictId || !memo.trim()}
                      className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                      {memoLoading ? 'Ï†ÄÏû• Ï§ë...' : 'Ï†ÄÏû•'}
                    </button>
                </div>
              </div>
            </Card>

              {/* Î©îÎ™® Î™©Î°ù Ïπ¥Îìú */}
              <Card title="Î©îÎ™® Î™©Î°ù">
                <div className="space-y-4 max-h-96 overflow-y-auto">
                  {notesLoading ? (
                    <div className="text-center py-8">
                      <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"></div>
                      <p className="mt-2 text-sm text-gray-500">Î©îÎ™®Î•º Î∂àÎü¨Ïò§Îäî Ï§ë...</p>
                    </div>
                  ) : allNotes.length === 0 ? (
                    <div className="text-center py-8 text-gray-500">
                      <p>Ï†ÄÏû•Îêú Î©îÎ™®Í∞Ä ÏóÜÏäµÎãàÎã§.</p>
                      <p className="text-sm mt-1">ÏÉàÎ°úÏö¥ Î©îÎ™®Î•º ÏûëÏÑ±Ìï¥Î≥¥ÏÑ∏Ïöî.</p>
                    </div>
                  ) : (
                    allNotes.map((note) => {
                      const district = DISTRICTS.find(d => d.id === (note as any).internalDistrictId);
                      const districtName = district?.name || `ÏûêÏπòÍµ¨ ${(note as any).internalDistrictId}`;
                      
                      return (
                        <div key={note.noteId} className="border border-gray-200 rounded-lg p-4 hover:bg-gray-50">
                          {/* ÏûêÏπòÍµ¨Î™ÖÍ≥º ÎÇ†Ïßú */}
                          <div className="flex items-center justify-between mb-2">
                            <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                              {districtName}
                            </span>
                            <span className="text-xs text-gray-500">
                              {new Date(note.createdAt).toLocaleDateString('ko-KR')}
                            </span>
                          </div>

                          {/* Î©îÎ™® ÎÇ¥Ïö© */}
                          {editingNoteId === note.noteId ? (
                            <div className="space-y-2">
                              <textarea
                                value={editingContent}
                                onChange={(e) => setEditingContent(e.target.value)}
                                className="w-full h-20 px-3 py-2 border border-gray-300 rounded-md resize-none focus:outline-none focus:ring-2 focus:ring-blue-500"
                              />
                              <div className="flex justify-end space-x-2">
                                <button
                                  onClick={cancelEditingNote}
                                  className="px-3 py-1 text-sm text-gray-600 hover:text-gray-800"
                                >
                                  Ï∑®ÏÜå
                                </button>
                                <button
                                  onClick={saveEditingNote}
                                  className="px-3 py-1 text-sm bg-blue-600 text-white rounded hover:bg-blue-700"
                                >
                                  Ï†ÄÏû•
                                </button>
                              </div>
                            </div>
                          ) : (
                            <div>
                              <p className="text-sm text-gray-900 mb-2 whitespace-pre-wrap">
                                {note.content}
                              </p>
                              <div className="flex justify-end space-x-2">
                                <button
                                  onClick={() => startEditingNote(note)}
                                  className="text-xs text-blue-600 hover:text-blue-800"
                                >
                                  ÏàòÏ†ï
                                </button>
                                <button
                                  onClick={() => deleteNoteFromList(note.noteId)}
                                  className="text-xs text-red-600 hover:text-red-800"
                                >
                                  ÏÇ≠Ï†ú
                                </button>
                              </div>
                            </div>
                          )}
                        </div>
                      );
                    })
                  )}
                </div>
              </Card>
            </div>
          </div>
        </main>
    </>
  );
};

// Loading fallback Ïª¥Ìè¨ÎÑåÌä∏
const ReportsSummaryLoading = () => (
  <div className="min-h-screen bg-gray-50">
    <Header />
    <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <div className="mb-8">
        <div className="h-8 bg-gray-200 rounded w-48 mb-2 animate-pulse"></div>
        <div className="h-4 bg-gray-200 rounded w-96 animate-pulse"></div>
      </div>
      <div className="space-y-8">
        <div className="h-64 bg-gray-200 rounded animate-pulse"></div>
        <div className="h-96 bg-gray-200 rounded animate-pulse"></div>
      </div>
    </main>
  </div>
);

// Î©îÏù∏ ÌéòÏù¥ÏßÄ Ïª¥Ìè¨ÎÑåÌä∏ - SuspenseÎ°ú Í∞êÏã∏Í∏∞
const ReportsSummaryPage = () => {
  return (
    <ErrorBoundary>
      <div className="min-h-screen bg-gray-50">
        <Suspense fallback={<ReportsSummaryLoading />}>
          <ReportsSummaryContent />
        </Suspense>
      </div>
    </ErrorBoundary>
  );
};

export default ReportsSummaryPage;
